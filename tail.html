<!doctype html>
<html>
	<head>
		<style type="text/css">
			body {
				text-align: left;
				font-family: monospace;
				font-size: 13px;
				position: absolute;
				top: 0;
				bottom: 0;
				right: 0;
				left: 0;
				overflow-y: scroll;
			}

			.line {
				padding-left: 50px;
				text-indent: -50px;
				white-space: pre;
			}
			.line.nginx {
				color: gray;
			}
			.line.fatal {
				color: red;
			}
			.multiple {
				margin-bottom: 5px;
			}
			.line.filtered {
				display: none;
			}

			#controls {
				position: fixed;
				top: 5px;
				right: 5px;
			}
		</style>

		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			$(document).ready(function() {
				var $body = $('body');
				var autoscroll = true;
				var socket = io.connect('//');
				var match = /./;

				socket.on('msg', function (message) {
					var div = $('<div class="line"></div>');
					$(div).text(message.data);

					if (! match.test(message.data)) {
						$(div).addClass('filtered');
					}
					if (message.data.indexOf('nginx') != -1) {
						$div.addClass('nginx');
						if (message.data.indexOf(' 500 ') != -1) {
							$div.addClass('fatal');
						}
					} else if (message.data.indexOf('PHP Fatal error') != -1) {
						$div.addClass('fatal');
					} else if (message.data.indexOf('xception') != -1 ) {
						$div.addClass('fatal');
					}
					if (message.data.indexOf('\n') != -1 ) {
						$div.addClass('multiple');
					}

					$body.append($div);

					if (autoscroll) {
						window.scroll(0, document.height);
					}
				});

				$('#autoscroll').toggle(function() {
					autoscroll = false;
				}, function() {
					autoscroll = true;
				});

				$('#regexaction').click(function() {
					try {
						match = new RegExp($('#regex').attr('value'));
						$('div.line').each(function(i, e) {
							if (match.test($(e).text())) {
								$(e).removeClass('filtered');
							} else {
								$(e).addClass('filtered');
							}
						});
					} catch(error) {
						$('#regex').addClass('fatal');
						console.error("Invalid regexp: " + error);
						return;
					}
					$('#regex').removeClass('fatal');
				});
			});
	</script>
	</head>

	<body>
		<div id="controls">
			<fieldset>
				<legend>Controls</legend>
				Regex filter: <input id="regex" value="."/>
				<button id="regexaction">Filter</button>
				<button id="autoscroll">Toggle autoscroll</button>
			</fieldset>
		</div>
		<div id="log"></div>
	</body>
</html>
